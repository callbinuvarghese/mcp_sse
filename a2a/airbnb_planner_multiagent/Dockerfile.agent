# syntax=docker/dockerfile:1
FROM ghcr.io/astral-sh/uv:0.6.11-python3.12-bookworm-slim
# one Dockerfile for building multiple agent containers with args as directory and module

# Build args (passed from cloudbuild step) 
# AGENT_DIR passed in build docker phas as AGENT_DIR=a2a/airbnb_planner_multiagent/airbnb_agent
# MODULE will be passed as either MODULE=airbnb_agent or host_agent
ARG AGENT_DIR
ARG MODULE

# Show them in build logs and fail fast if missing
RUN echo ">>> Build args:" && echo "    MODULE=${MODULE}" && echo "    AGENT_DIR=${AGENT_DIR}" \
 && test -n "${MODULE}" || (echo "ERROR: MODULE is empty"; exit 1) \
 && test -n "${AGENT_DIR}" || (echo "ERROR: AGENT_DIR is empty"; exit 1)

# Make MODULE available at runtime too
ENV MODULE=${MODULE}

WORKDIR /app

# Install shared deps (adjust if you have uv.lock)
COPY a2a/airbnb_planner_multiagent/pyproject.toml ./pyproject.toml
RUN uv sync --no-install-project || true

# Copy the selected agentâ€™s code
COPY ${AGENT_DIR}/ /app/${MODULE}/

# Prove the files landed where expected
RUN echo ">>> Post-COPY layout for /app/${MODULE}:" \
 && ls -la /app/${MODULE} || (echo "ERROR: /app/${MODULE} missing"; exit 1) \
 && test -f /app/${MODULE}/__main__.py || (echo "ERROR: __main__.py missing"; exit 1)

ENV PATH="/app/.venv/bin:${PATH}"

# Optional: echo again at runtime, then start the server (good for troubleshooting)
CMD uv run sh -lc 'echo "Runtime MODULE=${MODULE}"; echo "Runtime PORT=${PORT:-8080}"; exec python -m "${MODULE}" --host 0.0.0.0 --port "${PORT:-8080}"'

