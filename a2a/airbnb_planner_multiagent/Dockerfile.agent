# syntax=docker/dockerfile:1
# one Dockerfile for building multiple agent containers with args as directory and module

# 1) Base image with uv + Python
FROM ghcr.io/astral-sh/uv:0.6.11-python3.12-bookworm-slim

# 2) Build args: which agent folder to copy and which module to run
ARG AGENT_DIR
ARG MODULE

WORKDIR /app

# 3) Install shared deps from the single pyproject.toml
COPY a2a/airbnb_planner_multiagent/pyproject.toml ./pyproject.toml
# If you later add a lock file, also:
# COPY a2a/airbnb_planner_multiagent/uv.lock ./uv.lock

# Install dependencies into /app/.venv (no project install needed)
RUN --mount=type=cache,target=/root/.cache/uv uv sync --no-install-project

# 4) Copy only the selected agentâ€™s code (module must have __main__.py)
COPY ${AGENT_DIR}/ /app/${MODULE}/

ENV PATH="/app/.venv/bin:${PATH}"

# 5) Run the selected module (shell form to expand ${MODULE})
# CMD uv run python -m ${MODULE}

EXPOSE 8081
CMD uv run sh -lc 'python -m ${MODULE} --host 0.0.0.0 --port ${PORT:-8081}'

